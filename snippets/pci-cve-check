# Checks a list of CVE codes for PCI scans on a RHEL4 server.  Takes a html 
# or txt file containing CVE codes as an argument.
# Usage: pcicvecheck RHELVERSION FILE
# Usage: pcicvecheck RHELVERSION CVE1 CVE2 [...]

function pcicvesearch () {
    rhstring="$1"
    shift
    if [[ -e "$1" ]]; then
        cves="$( cat "$1" |sed 's/\(CVE-[0-9]\{4\}-[0-9]\{4\}\)/\n\1\n/g'|egrep "CVE-[0-9]{4}-[0-9]{4}"|sort|uniq )"
    else
        cves="$@"
    fi
    for cve in $cves; do
        echo "$cve"
        rhurl="$(links -dump "http://www.google.com/search?q=\"$rhstring\" site:rhn.redhat.com/errata \"$cve\""|egrep 'RHSA.*.html'|sed 's/^ *//'|sed 's/.html.*/.html/')"
        if [[ -n "$rhurl" ]]; then
            echo "$rhurl"
        else
            rhstmt="$(links -dump "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve"|sed -n '/Vendor Statments/,/References to Advisories/p'|sed '$d')"
            if [[ -n "$rhstmt" ]]; then
                echo "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve"
                echo "$rhstmt"
            else
                cvedesc="$(links -dump "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"|sed -n '/Description/,/References/p'|sed -e 's/^.................//' -e 's/    *.*$//' -e '/^$/d')"
                if [[ -n "$cvedesc" ]]; then
                    echo "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"
                    echo "$cvedesc"
                else
                    echo "Nothing found."
                fi
            fi
        fi
        echo
    done
}
function pcicvecheck () {
    if [[ "$1" == "rhel3" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux ES (v. 3)" "$@"
    elif [[ "$1" == "rhel4" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux ES (v. 4)" "$@"
    elif [[ "$1" == "rhel5" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux (v. 5 server)" "$@"
    else
        echo "Usage: cvecheck RHELVERSION FILE1 [FILE2]
Example: cvecheck rhel5 /tmp/pci-report.html"
    fi
}
pcicvecheck 
