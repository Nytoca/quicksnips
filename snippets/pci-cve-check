# Checks a list of CVE codes for PCI scans on a RHEL4 server.
# Usage: cvechkrhel4 file1 [file2] ...

function pcicvesearch () {
    for cve in $( cat $* |sed 's/\(CVE-[0-9]\{4\}-[0-9]\{4\}\)/\n\1\n/g'|egrep "CVE-[0-9]{4}-[0-9]{4}"|sort|uniq ); do
	echo -e "\n$cve"
	rhurl="$(links -dump "http://www.google.com/search?q=$1 site:rhn.redhat.com/errata"|egrep 'RHSA.*.html'|sed 's/^ *//'|sed 's/.html.*/.html/')"
	if [[ -n "$rhurl" ]]; then
	    echo "$rhurl"
	else
	    rhstmt="$(links -dump "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve"|grep -A10 "Vendor Statments")"
	    if [[ -n "$rhstmt" ]]; then
		echo "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve"
		echo "$rhstmt"
	    else
		cvedesc="$(links -dump "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"|grep -A5 Description|sed -e 's/^.................//' -e 's/    *.*$//')"
		if [ -n "$cvedesc" ]; then
		    echo "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"
		    echo "$cvedesc"
		fi
	    fi
	fi
    done
}
function pcicvecheck () {
    rhelversion="$1"
    shift
    if [[ "$rhelversion" == "rhel3" ]]; then
	pcicvesearch "Red Hat Enterprise Linux ES (v. 3)" "$@"
    elif [[ "$rhelversion" == "rhel4" ]]; then
	pcicvesearch "Red Hat Enterprise Linux ES (v. 4)" "$@"
    elif [[ "$rhelversion" == "rhel5" ]]; then
	pcicvesearch "Red Hat Enterprise Linux (v. 5 server)" "$@"
    else
	echo "Usage: cvecheck RHELVERSION FILE1 [FILE2]
Example: cvecheck rhel5 /tmp/pci-report.html"
    fi
}
pcicvecheck 
