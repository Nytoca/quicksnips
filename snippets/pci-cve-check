# Checks a list of CVE codes for PCI scans on a RHEL4 server.
# Takes a html or txt file containing CVE codes as an argument.
# Usage: pci_cve_check RHELVERSION FILE
# Usage: pci_cve_check RHELVERSION CVE1 CVE2 [...]

function pcicvesearch () {
    ggl=$(mktemp)
    exec 3>$ggl
    nist=$(mktemp)
    exec 4>$nist
    mitre=$(mktemp)
    exec 5>$mitre
    rhstring="$1"
    shift
    if [[ -e "$1" ]]; then
        cves="$( cat "$1" |sed 's/\(CVE-[0-9]\{4\}-[0-9]\{4\}\)/\n\1\n/g'|egrep "CVE-[0-9]{4}-[0-9]{4}"|sort|uniq )"
    else
        cves="$@"
    fi
    for cve in $cves; do
        echo "Checking ${cve}..."
        rhurl="$(links -dump "http://www.google.com/search?q=\"$rhstring\" site:rhn.redhat.com/errata \"$cve\""|egrep 'RHSA.*.html'|sed 's/^ *//'|sed 's/.html.*/.html/')"
        if [[ -n "$rhurl" ]]; then
            echo "$cve" 1>&3
            echo "$rhurl" 1>&3
            echo 1>&3
        else
            rhstmt="$(links -dump "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve"|sed -n '/Vendor Statments/,/References to Advisories/p'|sed '$d')"
            if [[ -n "$rhstmt" ]]; then
                echo "$cve" 1>&4
                echo "http://web.nvd.nist.gov/view/vuln/detail?vulnId=$cve" 1>&4
                echo "$rhstmt" 1>&4
                echo 1>&4
            else
                cvedesc="$(links -dump "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve"|sed -n '/Description/,/References/p'|sed -e 's/^.................//' -e 's/    *.*$//' -e '/^$/d')"
                if [[ -n "$cvedesc" ]]; then
                    echo "$cve" 1>&5
                    echo "http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cve" 1>&5
                    echo "$cvedesc" 1>&5
                    echo 1>&5
                else
                    echo "Nothing found." 1>&2
                fi
            fi
        fi
    done
    echo -e "Done.  Report follows...\n"
    cat $ggl $nist $mitre > /tmp/pci_cve_check.out
    if [[ $(cat /tmp/pci_cve_check.out|wc -l) -gt 50 ]]; then
        echo "Report in /tmp/pci_cve_check.out."
    else
        cat /tmp/pci_cve_check.out
    fi
    exec 3>&-
    exec 4>&-
    exec 5>&-
}
function pci_cve_check () {
    if [[ "$1" == "rhel3" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux ES (v. 3)" "$@"
    elif [[ "$1" == "rhel4" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux ES (v. 4)" "$@"
    elif [[ "$1" == "rhel5" ]]; then
        shift
        pcicvesearch "Red Hat Enterprise Linux (v. 5 server)" "$@"
    else
        echo "Usage: cvecheck RHELVERSION FILE1 [FILE2]
Example: cvecheck rhel5 /tmp/pci-report.html"
    fi
}
pci_cve_check 
