# Check on server health and reports warnings.

function warningmsg () { tput setaf 1; echo "WARNING: $1"; tput sgr0; }
function serverhealthcheck () {

if [[ $(who|wc -l) -gt 1 ]]; then
    warningmsg "Other users are logged in."
    who
fi
swapdat=$(mktemp)
swappts=3
sar -r|sed '$d'|tail -n$swappts|awk '{ print $10 }' > $swapdat
sdsh=$(mktemp)
curl -s http://quicksnips.org/sd.sh > $sdsh
swapsd=$(sh $sdsh $swapdat)
rm -f $swapdat $sdsh
if [[ $swapsd -gt 5 ]]; then
    warningmsg "Server is currently swapping."
fi
memavail=$( free -m|sed -n 3p|awk '{ print $4 }' )
if [[ $memavail -lt 50 ]]; then
    warningmsg "There are only $memavail MB of free memory"
fi
dfroot=$( df -Pm|sed 1d|awk '$6 ~ /^\/$/ { print $4 }' )
if [[ $dfroot -lt 1024 ]]; then
    warningmsg "The root partition only has $dfroot MB available"
fi
if [[ ! $( mysql -e exit 2>/dev/null || echo denied ) == "denied" ]]; then
    mcused=$( mysql -Bse 'show full processlist'|wc -l )
    mctotal=$( mysql -Bse "show variables like '%max_connections%'" | awk '{ print $2 }' )
    let mcleft=$mctotal-$mcused
    if [[ $mcleft -lt 10 ]]; then
	warningmsg "MySQL connections used/total: $mcused/$mctotal"
    fi
else
    echo "root can't login to mysql."
fi
acused=$( pgrep httpd|wc -l )
actotal=$( egrep "^MaxClients" /etc/httpd/conf/httpd.conf | head -n1 | awk '{print $2}' )
let acleft=$actotal-$acused
if [[ $acleft -lt 10 ]]; then
    warningmsg "Apache MaxClients used/total: $acused/$actotal"
fi
}
serverhealthcheck
