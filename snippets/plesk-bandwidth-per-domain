# Shows the outgoing bandwidth per domain in Plesk for the current month.

function pleskbandwidthdomain () {
    statsfile=$(mktemp)
    mysql psa -Bse 'select name, date, http_out + ftp_out + smtp_out + pop3_imap_out from DomainsTraffic, domains where DomainsTraffic.dom_id=domains.id' > $statsfile
    for dom in $( awk '{ print $1 }' $statsfile|sort|uniq ); do
	grep $dom $statsfile | awk -v date="$(date +%Y-%m)" '$2 ~ date' |
	awk -v dom=$dom '{ sum+=$3 } END { printf "%7.2f GB %s\n", sum/1024/1024/1024, dom }'
    done | sort -n | tail -n20
}
pleskbandwidthdomain
